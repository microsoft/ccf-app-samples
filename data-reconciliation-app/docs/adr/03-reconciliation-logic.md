# Data Reconciliation Logic

## Status

Proposed

## Context

Once data is ingested into the app, Members/Users will query for the data to be reconciled against others.

## Requirements

- Reconciliation is a process of matching data submitted by each user to ensure whether they are consistent with each other or not. In our application reconciliation is on each record.
- Reconciliation will only apply to data that the user has submitted.
- When a user requests for reconciliation report, it is generated for the user's current dataset stored in the network.
- Result will only have the current user's data compared with other users' data.

## When Reconciliation Happens

When a user requests a reconciliation report via the `/report` endpoint, it is generated using the data that the user has previously ingested.

This decouples data ingestion from reconciliation reporting.

Reconciliation is implemented by querying CFF KV Store for all the keys this user has submitted. Any keys unknown to this user are not used in the reconciliation report. This ensures the user only sees a report with their submitted data.

## Scenarios

### Querying for a Specific Record

If a user requests for Reconciliation Report for a specific key, it is generated by comparing that key's value to other users' submissions.

This request checks if the user has previously submitted this key or not.

### Querying for all Data

If a user requests for Reconciliation Report for all keys, it is generated by comparing all those keys' value to other users' submissions.

## Rules

**Current User:** User requesting Reconciliation Report

Each record will have all the values submitted by each user. So, for each record, the reconciliation will be performed by comparing the current user's submitted value to others.

### KV Storage: Simple Map Based on Keys

```json
{
  "key": "A0129",
  "values": {
      "Member 1": "google",
      "Member 2": "alphabet",
      ...
      "Member N": "...",
    }
}
```

### Voting Threshold

Reconciliation logic is considered only if a specified number of users have submitted that record. The [voting_threshold](https://github.com/microsoft/ccf-app-samples/blob/main/data-reconciliation-app/src/utils/constants.ts) determines if the record has been submitted by enough users. This is configurable and can be set by members of the network, depending on the size of the network.

### For each record in the KV Storage

The first thing to look for is whether the current User has submitted any value for this record. If not, this record will be skipped right away.

Otherwise, the reconciliation for that particular record can have three possible states:

- `NOT_ENOUGH_DATA`: If the count of users who submitted that key is less than the `voting_threshold`.
- `LACK_OF_CONSENSUS`: If the threshold is met and at least one of the submitted values differs from all of the others.
- `IN_CONSENSUS`: If the threshold is met and all the users have submitted the same value.

This state will come under the `group_status` field in the final Report.

### Sample Summary Result Schema and Report Mapping

In addition to `group_status`, additional statistics will be retrieved for the record to be later consolidated in the Report:

- Total number of values submitted (useful for reporting but will not be made public)
- Number of distinct values for that key (count of different opinions for the record)
- Number of members that agree with the current user
- If the member's opinion is in accordance with the majority or minority of votes

Information will be consolidated into a Summary Result object that will be used by the Reporting API.
The following proposed schema represents a reconciled record. The output Report will then be generated based on this data. In the reconciled record key and value will match the schema defined.

```json
{
  "lei": "<record key>",
  "nace": "<value informed by User>",
  "group_status": "<value>",
  "total_votes_count": "#",                 // total opinions count - initially commented (DEMO CHANGE)
  "count_of_unique_values": "#",            // count of unique values
  "members_in_agreement": "#",              // # of members in agreement with the User value
  "majority_minority": "<calculated value>" // relative to the number of active members in the network
} 
```

Where:

```typescript
record = // current record being reconciled
userId = // user requesting reconciliation
totalUsersInNetwork = // number of users in the system
voting_threshold = // specified threshold value required for our calculations

key = record.key;

value = record.values[userId]

// Number of opinions
total_votes_count = record.values.length

// removing duplicates from Users' submitted values
count_of_unique_values = (new Set(Object.values(record.values))).length

// Filtering all votes that are similar to the current user
members_in_agreement = 
    Object.keys(record.values).filter(
        (key) => key != userId && record.values[key] == user_opinion
    ).length

// Defining reconciliation status
group_status = (total_votes_count/totalUsersInNetwork) < voting_threshold 
                ? 'NOT_ENOUGH_DATA'
                : (unique_opinions.size() != 1) ? 'LACK_OF_CONSENSUS' : 'IN_CONSENSUS'

// Majority/minority classification according to network
majority_minority = (members_in_agreement / totalUsersInNetwork) > 0.5 ? 'majority' : 'minority'

```
Report Column         | Object Mapping        | description 
----------------------|-----------------------|------------
KEY                   |key                    | Record Id
ATTRIBUTE_N           |value                  | Value submitted by User
GROUP_STATUS          |group_status           | Reconciliation result
UNIQUE_VALUES         |count_of_unique_values | Number of Distinct values submitted for this record
MEMBERS_IN_AGREEMENT  |members_in_agreement   | Number of members with same data as User
MINORITY_MAJORITY     |majority_minority      | Comparison between agreement total votes

## Pseudo Code

Please refer to [Data Reconciliation - Pseudo Code](https://github.com/microsoft/ccf-app-samples/blob/main/data-reconciliation-app/docs/data-reconciliation.md#pseudo-code)

## Resources

- [Data Reconciliation in the Project Context](https://github.com/microsoft/ccf-app-samples/blob/main/data-reconciliation-app/docs/data-reconciliation.md)
- [Data Schema Data Flow](https://github.com/microsoft/ccf-app-samples/blob/main/data-reconciliation-app/docs/data-schema-data-flow.md)
